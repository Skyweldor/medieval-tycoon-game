<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medieval Tycoon - With Real Assets</title>

  <!-- External CSS (Phase 0 refactoring) -->
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/layout.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/game-world.css">
  <link rel="stylesheet" href="styles/merchant.css">
  <link rel="stylesheet" href="styles/animations.css">

  <!-- Module entry point - all game logic is in ES modules -->
  <script type="module" src="src/main.js"></script>

</head>
<body>
  <div class="game-container">
    <!-- Header -->
    <div class="header">
      <h1>Medieval Tycoon</h1>
      <p>Build your village, harvest resources, grow your empire!</p>
    </div>

    <!-- Resource Bar -->
    <div class="resource-bar">
      <div class="resource">
        <span class="icon icon-32 icon-gold"></span>
        <div class="resource-info">
          <span class="resource-name">Gold</span>
          <span class="resource-value" id="gold-value">50</span>
          <span class="resource-rate neutral" id="gold-rate">+0/s</span>
        </div>
      </div>
      <div class="resource">
        <span class="icon icon-32 icon-wheat"></span>
        <div class="resource-info">
          <span class="resource-name">Wheat</span>
          <span class="resource-value" id="wheat-value">0</span>
          <span class="resource-rate neutral" id="wheat-rate">+0/s</span>
        </div>
      </div>
      <div class="resource">
        <span class="icon icon-32 icon-stone"></span>
        <div class="resource-info">
          <span class="resource-name">Stone</span>
          <span class="resource-value" id="stone-value">0</span>
          <span class="resource-rate neutral" id="stone-rate">+0/s</span>
        </div>
      </div>
      <div class="resource">
        <span class="icon icon-32 icon-wood"></span>
        <div class="resource-info">
          <span class="resource-name">Wood</span>
          <span class="resource-value" id="wood-value">0</span>
          <span class="resource-rate neutral" id="wood-rate">+0/s</span>
        </div>
      </div>
      <!-- Royal Stipend Indicator -->
      <div class="stipend-indicator" id="stipend-indicator">
        <span>ğŸ‘‘</span>
        <span>Royal Stipend: +1ğŸ’°/2s</span>
      </div>
    </div>

    <!-- Main 3-Column Layout -->
    <div class="main-layout">
      <!-- Left Panel - Tabbed (Inspect / Build) -->
      <div class="left-panel">
        <div class="left-tabbed-panel">
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchLeftTab('inspect')" title="Inspect">ğŸ”</button>
            <button class="tab-btn" onclick="switchLeftTab('build')" title="Build">ğŸ”¨</button>
            <button class="tab-btn" onclick="switchLeftTab('research')" title="Research">ğŸ“š</button>
          </div>

          <!-- Inspect Tab -->
          <div class="tab-content active" id="left-tab-inspect">
            <div class="building-info-empty" id="building-info-empty">
              ğŸ  Hover over a building to see its details
            </div>
            <div class="building-info-content" id="building-info-content" style="display: none;">
              <div class="building-info-header">
                <span class="building-info-icon" id="info-icon">ğŸŒ¾</span>
                <div class="building-info-title">
                  <h3 id="info-name">Building Name</h3>
                  <span class="level-text" id="info-level">Level 1</span>
                </div>
              </div>
              <div class="building-info-stats">
                <div class="info-stat-row">
                  <span class="info-stat-label">Status</span>
                  <span class="info-stat-value" id="info-status">Active</span>
                </div>
                <div class="info-stat-row" id="info-upgrade-row">
                  <span class="info-stat-label">Upgrade Cost</span>
                  <span class="info-stat-value" id="info-upgrade-cost">100 ğŸ’°</span>
                </div>
              </div>
              <div class="info-production">
                <div class="info-production-title">Production (per second)</div>
                <div id="info-production-list">
                  <!-- Generated by JS -->
                </div>
              </div>
            </div>
          </div>

          <!-- Build Tab -->
          <div class="tab-content" id="left-tab-build">
            <div class="build-tab-header">
              Select a building to place:
            </div>
            <div class="build-list" id="build-list">
              <!-- Generated by JS -->
            </div>
            <div class="build-cancel" id="build-cancel" style="display: none;">
              <button class="btn btn-reset" onclick="cancelPlacement()">âŒ Cancel</button>
            </div>
            <!-- Demolish Section -->
            <div class="demolish-section">
              <button class="btn btn-demolish" id="demolish-btn" onclick="toggleDemolishMode()">
                ğŸ”¨ Demolish
              </button>
            </div>
            <div class="demolish-cancel" id="demolish-cancel" style="display: none;">
              <button class="btn btn-reset" onclick="cancelDemolish()">âŒ Cancel Demolish</button>
            </div>
          </div>

          <!-- Research Tab -->
          <div class="tab-content" id="left-tab-research">
            <div class="research-progress-header">
              <span>Progress: </span>
              <span id="research-progress">0/15</span>
            </div>
            <div class="expand-plot-section" id="expand-plot-section" style="display: none;">
              <button class="btn btn-expand" onclick="expandPlot()">
                ğŸ—ºï¸ Expand Borders
              </button>
            </div>
            <div class="research-list" id="research-list">
              <!-- Generated by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- Center Content -->
      <div class="center-content">
        <!-- Game World -->
        <div class="game-world" id="game-world">
          <!-- In-Canvas Resource Overlay - Generated dynamically by ResourceDisplayController -->
          <div class="resource-overlay" id="resource-overlay">
            <!-- Content generated from resource registry -->
          </div>
          <div class="debug-grid"></div>
          <div class="ground-layer"></div>
          <div class="highlight-layer"></div>
          <div class="building-layer" id="building-layer">
            <!-- Buildings will be inserted here by JavaScript -->
          </div>
        </div>


        <!-- Debug Sliders (hidden by default) -->
        <div class="debug-sliders" id="debug-sliders" style="display: none;">
          <div style="font-size: 10px; color: #aaa; margin-bottom: 5px;">Building Offsets:</div>
          <div class="slider-group">
            <label>X Offset: <span id="x-offset-value">2</span>px</label>
            <input type="range" id="x-offset-slider" min="-50" max="50" value="2" step="1">
          </div>
          <div class="slider-group">
            <label>Y Offset: <span id="y-offset-value">-8</span>px</label>
            <input type="range" id="y-offset-slider" min="-50" max="50" value="-8" step="1">
          </div>
          <div class="slider-group">
            <label>Size Mult: <span id="size-mult-value">2.0</span></label>
            <input type="range" id="size-mult-slider" min="1.0" max="3.0" value="2.0" step="0.1">
          </div>
          <div style="font-size: 10px; color: #aaa; margin: 8px 0 5px;">Cursor Offsets:</div>
          <div class="slider-group">
            <label>Cursor X: <span id="cursor-x-value">-1</span>px</label>
            <input type="range" id="cursor-x-slider" min="-50" max="50" value="-1" step="1">
          </div>
          <div class="slider-group">
            <label>Cursor Y: <span id="cursor-y-value">-1</span>px</label>
            <input type="range" id="cursor-y-slider" min="-50" max="50" value="-1" step="1">
          </div>
          <button class="btn btn-reset" onclick="copyDebugValues()">ğŸ“‹ Copy Values</button>
        </div>
      </div>

      <!-- Right Panel - Tabbed Interface -->
      <div class="right-panel">
        <div class="tabbed-panel">
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('milestones')">ğŸ“œ Milestones</button>
            <button class="tab-btn" onclick="switchTab('market')">ğŸª Market</button>
          </div>

          <!-- Milestones Tab -->
          <div class="tab-content active" id="tab-milestones">
            <div class="milestone-progress-header">
              <span>Progress: </span>
              <span id="milestone-progress">0/8</span>
            </div>
            <div class="milestone-list" id="milestone-list">
              <!-- Generated by JS -->
            </div>
          </div>

          <!-- Market Tab -->
          <div class="tab-content" id="tab-market">
            <div class="market-status" id="market-status">
              <div class="market-locked">
                ğŸ”’ Build a Market to unlock trading
              </div>
            </div>
            <div class="market-trading-content" id="market-trading-content" style="display: none;">
              <div class="market-level-display">
                <span>Market Level: </span>
                <span id="market-level">1</span>
              </div>
              <div class="market-trades" id="market-trades">
                <!-- Generated by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications Container -->
  <div class="notifications" id="notifications"></div>

  <!-- Merchant Banner -->
  <div class="merchant-banner" id="merchant-banner">
    <div class="merchant-avatar">ğŸ§³</div>
    <div class="merchant-info">
      <div class="merchant-title">Traveling Merchant</div>
      <div class="merchant-timer">Leaving in <span id="merchant-countdown">30</span>s</div>
    </div>
    <button class="merchant-trade-btn" onclick="openMerchantPanel()">Trade</button>
  </div>

  <!-- Merchant Trading Overlay -->
  <div class="merchant-overlay" id="merchant-overlay" onclick="closeMerchantPanel()">
    <div class="merchant-panel" onclick="event.stopPropagation()">
      <div class="merchant-header">
        <span class="merchant-face">ğŸ§”</span>
        <div class="merchant-header-info">
          <h3>Traveling Merchant</h3>
          <p class="merchant-dialogue" id="merchant-dialogue">"What would you like to sell today?"</p>
        </div>
        <div class="merchant-timer-badge">
          <span id="merchant-panel-countdown">30</span>s
        </div>
      </div>

      <div class="trade-rows" id="merchant-trade-rows">
        <!-- Generated by JS -->
      </div>

      <div class="merchant-footer">
        <span class="merchant-tip">ğŸ’¡ Build a Market for better prices!</span>
        <button class="btn-close" onclick="closeMerchantPanel()">Close</button>
      </div>
    </div>
  </div>

  <!-- DEV Panel (hidden by default, shown with ?dev=1) -->
  <div class="dev-panel" id="dev-panel" style="display: none;">
    <div class="dev-panel-header">
      <span>ğŸ”§ DEV Panel</span>
      <span class="dev-status" id="dev-save-status">No save data</span>
    </div>

    <!-- Save/Load Controls -->
    <div class="dev-section">
      <div class="dev-section-title">Persistence</div>
      <div class="dev-btn-row">
        <button class="dev-btn" onclick="window.devSaveNow()">ğŸ’¾ Save</button>
        <button class="dev-btn" onclick="window.devLoadSave()">ğŸ“‚ Load</button>
        <button class="dev-btn danger" onclick="window.devClearSave()">ğŸ—‘ï¸ Clear</button>
      </div>
      <div class="dev-btn-row">
        <button class="dev-btn" onclick="window.devExportSave()">ğŸ“‹ Export JSON</button>
        <button class="dev-btn" onclick="window.devImportSave()">ğŸ“¥ Import JSON</button>
      </div>
      <textarea class="dev-textarea" id="dev-import-textarea" placeholder="Paste save JSON here..."></textarea>
      <button class="dev-btn active" id="dev-autosave-btn" onclick="window.devToggleAutosave()">Autosave: ON</button>
    </div>

    <!-- Speed Controls -->
    <div class="dev-section">
      <div class="dev-section-title">Game Speed</div>
      <div class="dev-speed-buttons" id="dev-speed-buttons">
        <!-- Generated by JS -->
      </div>
    </div>

    <!-- Resource Spawning -->
    <div class="dev-section">
      <div class="dev-section-title">Spawn Resources</div>
      <div class="dev-btn-row">
        <button class="dev-btn" onclick="window.devSpawnResource('gold')">+100 ğŸ’°</button>
        <button class="dev-btn" onclick="window.devSpawnResource('wheat')">+50 ğŸŒ¾</button>
      </div>
      <div class="dev-btn-row">
        <button class="dev-btn" onclick="window.devSpawnResource('stone')">+50 ğŸª¨</button>
        <button class="dev-btn" onclick="window.devSpawnResource('wood')">+50 ğŸªµ</button>
      </div>
      <button class="dev-btn wide" onclick="window.devSpawnAll()">ğŸ Spawn All</button>
    </div>

    <!-- Debug Tools -->
    <div class="dev-section">
      <div class="dev-section-title">Debug Tools</div>
      <div class="dev-btn-row">
        <button class="dev-btn" onclick="toggleCameraDebug()" title="Toggle camera debug display">ğŸ“· Camera</button>
        <button class="dev-btn" onclick="toggleTiles()" id="toggle-tiles-btn">ğŸ™ˆ Tiles</button>
      </div>
      <div class="dev-btn-row">
        <button class="dev-btn" onclick="toggleDebugSliders()" id="toggle-sliders-btn">ğŸ”§ Offsets</button>
        <button class="dev-btn" onclick="toggleDarkMode()" id="toggle-dark-btn">ğŸŒ™ Dark</button>
      </div>
    </div>
  </div>

  <!-- Initialization script - waits for module to load then starts the game -->
  <script>
    // Wait for ES module to be ready before initializing
    let waitAttempts = 0;
    function waitForModuleAndInit() {
      waitAttempts++;
      if (window.initializeUI) {
        console.log('[Init] Module loaded after ' + waitAttempts + ' attempts, calling initializeUI()');
        try {
          window.initializeUI();
          console.log('[Init] Game initialized successfully');
        } catch (e) {
          console.error('[Init] Error initializing game:', e);
        }
      } else if (waitAttempts < 500) {
        // Module not loaded yet, wait and retry (max 5 seconds)
        setTimeout(waitForModuleAndInit, 10);
      } else {
        console.error('[Init] Module failed to load after 5 seconds. Check for import errors in browser console.');
      }
    }

    waitForModuleAndInit();
  </script>
</body>
</html>
