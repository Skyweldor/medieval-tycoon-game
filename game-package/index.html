<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè∞ Medieval Tycoon - With Real Assets</title>

  <!-- External CSS (Phase 0 refactoring) -->
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/layout.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/game-world.css">
  <link rel="stylesheet" href="styles/merchant.css">
  <link rel="stylesheet" href="styles/animations.css">

  <!-- Module entry point (loads config and sets up globals) -->
  <script type="module" src="src/main.js"></script>

  <!-- Legacy inline styles (keeping as fallback, can be removed once external CSS verified) -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(180deg, #87CEEB 0%, #90B855 40%, #5D7A3A 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .game-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Main 3-column layout */
    .main-layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    /* Left Panel - Building Info */
    .left-panel {
      width: 250px;
      flex-shrink: 0;
    }

    .left-tabbed-panel {
      background: linear-gradient(135deg, #5D4037 0%, #4E342E 100%);
      border-radius: 12px;
      border: 2px solid #8D6E63;
      overflow: hidden;
      min-height: 300px;
    }

    .left-tabbed-panel .tab-buttons {
      display: flex;
      background: rgba(0,0,0,0.2);
      border-bottom: 2px solid #8D6E63;
    }

    .left-tabbed-panel .tab-btn {
      flex: 1;
      padding: 10px;
      font-size: 1.2rem;
    }

    .left-tabbed-panel .tab-content {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    /* Build Tab Styles */
    .build-tab-header {
      color: #A99584;
      font-size: 0.8rem;
      margin-bottom: 10px;
      text-align: center;
    }

    .build-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .build-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .build-item:hover:not(.locked):not(.selected) {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
    }

    .build-item.selected {
      background: rgba(124, 179, 66, 0.3);
      border-color: #7CB342;
    }

    .build-item.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .build-item-icon {
      font-size: 1.5rem;
      width: 36px;
      text-align: center;
    }

    .build-item-info {
      flex: 1;
      min-width: 0;
    }

    .build-item-name {
      color: #fff;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .build-item-cost {
      color: #A99584;
      font-size: 0.7rem;
    }

    .build-item-cost.affordable {
      color: #7CB342;
    }

    .build-item-cost.unaffordable {
      color: #E57373;
    }

    .build-item-status {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0,0,0,0.3);
      color: #A99584;
    }

    .build-item-status.built {
      color: #7CB342;
    }

    .build-cancel {
      margin-top: 15px;
      text-align: center;
    }

    .build-cancel button {
      width: 100%;
    }

    /* Tile highlight effects - applied directly to tile elements */
    .tile.highlighted-valid {
      filter: brightness(1.3) sepia(0.5) hue-rotate(60deg) saturate(1.5);
      animation: tileHighlightPulse 0.8s infinite;
    }

    .tile.highlighted-invalid {
      filter: brightness(1.2) sepia(0.5) hue-rotate(-30deg) saturate(1.5);
      animation: tileHighlightPulse 0.8s infinite;
    }

    @keyframes tileHighlightPulse {
      0%, 100% { filter: brightness(1.3) sepia(0.5) hue-rotate(60deg) saturate(1.5); }
      50% { filter: brightness(1.5) sepia(0.6) hue-rotate(60deg) saturate(2); }
    }

    .tile.highlighted-invalid {
      animation-name: tileHighlightPulseInvalid;
    }

    @keyframes tileHighlightPulseInvalid {
      0%, 100% { filter: brightness(1.2) sepia(0.5) hue-rotate(-30deg) saturate(1.5); }
      50% { filter: brightness(1.4) sepia(0.6) hue-rotate(-30deg) saturate(2); }
    }

    /* Empty slot marker - minimal */
    .slot-empty {
      width: 32px !important;
      height: 32px !important;
      font-size: 1rem !important;
      opacity: 0.6;
      background: rgba(0,0,0,0.3) !important;
      border-radius: 50% !important;
      border: 2px dashed rgba(255,255,255,0.4) !important;
    }

    .building-slot:hover .slot-empty {
      opacity: 1;
      border-color: rgba(255,255,255,0.8) !important;
    }

    .building-info-panel {
      background: linear-gradient(135deg, #5D4037 0%, #4E342E 100%);
      border-radius: 12px;
      border: 2px solid #8D6E63;
      padding: 15px;
      min-height: 300px;
    }

    .building-info-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #8D6E63;
    }

    .building-info-icon {
      font-size: 2.5rem;
    }

    .building-info-title {
      flex: 1;
    }

    .building-info-title h3 {
      color: #F4D03F;
      font-size: 1.1rem;
      margin-bottom: 2px;
    }

    .building-info-title .level-text {
      color: #A99584;
      font-size: 0.75rem;
    }

    .building-info-empty {
      color: #A99584;
      text-align: center;
      padding: 40px 20px;
      font-style: italic;
    }

    .building-info-stats {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .info-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
    }

    .info-stat-label {
      color: #A99584;
      font-size: 0.8rem;
    }

    .info-stat-value {
      color: #fff;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .info-stat-value.positive { color: #7CB342; }
    .info-stat-value.negative { color: #E57373; }

    .info-production {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #8D6E63;
    }

    .info-production-title {
      color: #F4D03F;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    /* Center Content */
    .center-content {
      flex: 1;
      min-width: 0;
    }

    /* Right Panel - Tabs */
    .right-panel {
      width: 280px;
      flex-shrink: 0;
    }

    .tabbed-panel {
      background: linear-gradient(135deg, #5D4037 0%, #4E342E 100%);
      border-radius: 12px;
      border: 2px solid #8D6E63;
      overflow: hidden;
    }

    .tab-buttons {
      display: flex;
      background: rgba(0,0,0,0.2);
      border-bottom: 2px solid #8D6E63;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 10px;
      background: transparent;
      border: none;
      color: #A99584;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      background: rgba(255,255,255,0.05);
      color: #fff;
    }

    .tab-btn.active {
      background: rgba(255,255,255,0.1);
      color: #F4D03F;
      box-shadow: inset 0 -2px 0 #F4D03F;
    }

    .tab-content {
      display: none;
      padding: 15px;
      max-height: 450px;
      overflow-y: auto;
    }

    .tab-content.active {
      display: block;
    }

    /* Scrollbar styling for tab content */
    .tab-content::-webkit-scrollbar {
      width: 6px;
    }

    .tab-content::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
    }

    .tab-content::-webkit-scrollbar-thumb {
      background: #8D6E63;
      border-radius: 3px;
    }

    /* Milestone styles in tab */
    .milestone-progress-header {
      display: flex;
      justify-content: space-between;
      padding: 8px 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      margin-bottom: 10px;
      color: #F4D03F;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .tab-content .milestone-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tab-content .milestone-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      opacity: 0.6;
      transition: all 0.3s ease;
    }

    .tab-content .milestone-item.completed {
      opacity: 1;
      background: rgba(124, 179, 66, 0.2);
    }

    .tab-content .milestone-icon {
      font-size: 1rem;
      min-width: 20px;
    }

    .tab-content .milestone-info {
      flex: 1;
      min-width: 0;
    }

    .tab-content .milestone-name {
      font-weight: 600;
      color: #fff;
      font-size: 0.8rem;
    }

    .tab-content .milestone-desc {
      font-size: 0.65rem;
      color: #A99584;
    }

    .tab-content .milestone-reward {
      color: #F4D03F;
      font-weight: 700;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    /* Market styles in tab */
    .market-locked {
      text-align: center;
      padding: 30px 15px;
      color: #A99584;
      font-size: 0.9rem;
    }

    .market-level-display {
      display: flex;
      justify-content: space-between;
      padding: 8px 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      margin-bottom: 10px;
      color: #7CB342;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .tab-content .market-trades {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tab-content .market-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.06);
      border-radius: 6px;
    }

    .tab-content .market-res {
      min-width: 60px;
      font-weight: 600;
      color: #FFF;
      font-size: 0.85rem;
    }

    .tab-content .market-price {
      color: #F4D03F;
      font-weight: 700;
      font-size: 0.8rem;
      min-width: 40px;
    }

    .tab-content .market-btns {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }

    .tab-content .market-btns button {
      padding: 4px 8px;
      font-size: 0.65rem;
    }
    
    /* Header */
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .header h1 {
      font-size: 2.5rem;
      color: #4A3728;
      text-shadow: 2px 2px 0 #F4D03F, 4px 4px 0 rgba(0,0,0,0.2);
      margin-bottom: 5px;
    }
    
    .header p {
      color: #5D4E37;
      font-size: 0.9rem;
    }
    
    /* Resource Bar */
    .resource-bar {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      padding: 15px 20px;
      background: linear-gradient(135deg, #5D4037 0%, #4E342E 100%);
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 2px solid #8D6E63;
      margin-bottom: 20px;
    }
    
    .resource {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      min-width: 120px;
    }
    
    .resource-icon {
      font-size: 1.8rem;
      font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Twemoji Mozilla", sans-serif;
    }
    
    .resource-info {
      display: flex;
      flex-direction: column;
    }
    
    .resource-name {
      font-size: 0.65rem;
      color: #A99584;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .resource-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #fff;
      font-family: 'Courier New', monospace;
    }
    
    .resource-rate {
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .resource-rate.positive { color: #7CB342; }
    .resource-rate.negative { color: #E57373; }
    .resource-rate.neutral { color: #666; }
    
    /* Game World */
    .game-world {
      position: relative;
      width: 800px;
      height: 500px;
      background: linear-gradient(135deg, #7CB342 0%, #558B2F 50%, #33691E 100%);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: inset 0 4px 30px rgba(0,0,0,0.3);
      border: 3px solid #4A7C34;
      margin: 0 auto;
    }
    
    .ground-layer {
      position: absolute;
      inset: 0;
    }

    /* Highlight layer for placement preview - separate from ground to persist */
    .highlight-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    /* Debug grid layer - shows tile boundaries */
    .debug-grid {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .debug-line {
      position: absolute;
      background: rgba(0, 120, 180, 0.5);
      height: 1px;
      transform-origin: left center;
    }

    .debug-label {
      position: absolute;
      font-size: 7px;
      color: rgba(0, 60, 100, 0.9);
      font-family: monospace;
      font-weight: bold;
      text-shadow: 0 0 2px white, 0 0 2px white;
      z-index: 1;
      pointer-events: none;
    }

    .tile {
      position: absolute;
      width: var(--tile-width, 183px);
      height: var(--tile-height, 165px);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    .tile-grass {
      background-image: url('assets/ground_basic.png');
    }

    .tile-cobble {
      background-image: url('assets/cobble_basic.png');
    }

    .tile-dirt {
      background-image: url('assets/dirt_basic.png');
    }
    
    /* Building Slots */
    .building-slot {
      position: absolute;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: var(--building-size, 42px);
    }
    
    .building-slot:hover {
      transform: scale(1.05);
      z-index: 100;
    }
    
    .building-slot.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .building-slot.locked:hover {
      transform: none;
    }
    
    .building-image {
      width: var(--building-size, 42px);
      height: var(--building-size, 42px);
      object-fit: contain;
      filter: drop-shadow(0 0 8px rgba(255,220,100,0.6)) drop-shadow(2px 2px 3px rgba(0,0,0,0.4));
      transition: all 0.3s ease;
    }
    
    .building-slot:not(.locked):hover .building-image {
      filter: drop-shadow(0 0 12px rgba(255,220,100,0.9)) drop-shadow(3px 3px 5px rgba(0,0,0,0.4)) brightness(1.1);
    }
    
    .slot-placeholder {
      width: var(--placeholder-size, 42px);
      height: calc(var(--placeholder-size, 42px) * 0.6);
      border: 2px dashed rgba(255,255,255,0.6);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.25);
      font-size: 1.2rem;
      font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Twemoji Mozilla", sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 15px rgba(255,220,100,0.4);
    }

    .building-slot:not(.locked) .slot-placeholder {
      box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 20px rgba(100,255,100,0.5);
      border-color: rgba(100,255,100,0.7);
    }

    .building-slot:not(.locked):hover .slot-placeholder {
      box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 25px rgba(100,255,100,0.8);
      background: rgba(100,255,100,0.3);
    }

    .building-label {
      font-size: 0.55rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      margin-top: 2px;
      text-align: center;
      background: rgba(0,0,0,0.7);
      padding: 2px 6px;
      border-radius: 3px;
      white-space: nowrap;
    }
    
    .building-cost {
      font-size: 0.5rem;
      color: #7CB342;
      margin-top: 1px;
      font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Twemoji Mozilla", "Segoe UI", sans-serif;
      background: rgba(0,0,0,0.5);
      padding: 1px 4px;
      border-radius: 2px;
      white-space: nowrap;
    }

    .building-cost.unaffordable {
      color: #E57373;
    }

    .level-badge {
      position: absolute;
      top: -3px;
      right: -3px;
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #F4D03F 0%, #D4AC0D 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.5rem;
      font-weight: 900;
      color: #5D4037;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      border: 1px solid #fff;
    }
    
    /* Stats Panel */
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-box {
      padding: 15px;
      background: linear-gradient(135deg, #5D4037 0%, #4E342E 100%);
      border-radius: 12px;
      text-align: center;
      border: 2px solid #8D6E63;
    }
    
    .stat-label {
      font-size: 0.7rem;
      color: #A99584;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: #F4D03F;
    }
    
    /* Buttons */
    .button-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 25px;
      font-size: 0.9rem;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-reset {
      background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%);
      color: #fff;
      border: 2px solid #A1887F;
    }
    
    .btn-reset:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    /* Tooltips */
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.8rem;
      pointer-events: none;
      z-index: 1000;
      max-width: 200px;
      display: none;
    }
    
    /* Notifications */
    .notifications {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    
    .notification {
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .notification.success {
      background: linear-gradient(135deg, #7CB342 0%, #558B2F 100%);
      color: #fff;
    }
    
    .notification.error {
      background: linear-gradient(135deg, #E57373 0%, #C62828 100%);
      color: #fff;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Tips */
    .tips {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      text-align: center;
      color: #4A3728;
      font-size: 0.85rem;
    }

    .tips strong {
      color: #2E7D32;
    }

    /* Debug Sliders */
    .debug-sliders {
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, #333 0%, #222 100%);
      border-radius: 10px;
      border: 2px solid #555;
    }

    .debug-sliders .slider-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .debug-sliders label {
      color: #fff;
      font-size: 0.85rem;
      min-width: 140px;
    }

    .debug-sliders input[type="range"] {
      flex: 1;
      height: 8px;
      cursor: pointer;
    }

    .debug-sliders button {
      margin-top: 10px;
    }

    /* Royal Stipend Indicator */
    .stipend-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      border-radius: 8px;
      font-size: 0.75rem;
      color: #FFD54F;
      animation: pulse 2s infinite;
    }

    .stipend-indicator.inactive {
      display: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Milestone notification style */
    .notification.milestone {
      background: linear-gradient(135deg, #FFD700 0%, #FFA000 100%);
      color: #4E342E;
      font-weight: 700;
      border: 2px solid #FFECB3;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    /* Milestone Panel */
    .milestone-panel {
      margin-top: 20px;
      background: linear-gradient(135deg, #5D4037 0%, #4E342E 100%);
      border-radius: 12px;
      border: 2px solid #8D6E63;
      overflow: hidden;
    }

    .milestone-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      cursor: pointer;
      color: #F4D03F;
      font-weight: 700;
      user-select: none;
    }

    .milestone-header:hover {
      background: rgba(255,255,255,0.05);
    }

    .milestone-progress {
      font-size: 0.85rem;
      background: rgba(0,0,0,0.3);
      padding: 3px 8px;
      border-radius: 10px;
    }

    .milestone-list {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .milestone-list.collapsed {
      display: none;
    }

    .milestone-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      opacity: 0.6;
      transition: all 0.3s ease;
    }

    .milestone-item.completed {
      opacity: 1;
      background: rgba(124, 179, 66, 0.2);
    }

    .milestone-icon {
      font-size: 1.2rem;
      min-width: 24px;
      text-align: center;
    }

    .milestone-info {
      flex: 1;
      min-width: 0;
    }

    .milestone-name {
      font-weight: 600;
      color: #fff;
      font-size: 0.85rem;
    }

    .milestone-desc {
      font-size: 0.7rem;
      color: #A99584;
    }

    .milestone-reward {
      color: #F4D03F;
      font-weight: 700;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    /* Merchant Banner - slides in from top */
    .merchant-banner {
      position: fixed;
      top: -80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 20px;
      background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%);
      border-radius: 0 0 15px 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      border: 2px solid #A1887F;
      border-top: none;
      transition: top 0.5s ease;
      z-index: 500;
    }

    .merchant-banner.visible {
      top: 0;
    }

    .merchant-banner.urgent {
      animation: urgentPulse 0.5s infinite;
      border-color: #FF8A65;
    }

    @keyframes urgentPulse {
      0%, 100% { background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%); }
      50% { background: linear-gradient(135deg, #A1887F 0%, #8D6E63 100%); }
    }

    .merchant-avatar {
      font-size: 2rem;
    }

    .merchant-info {
      display: flex;
      flex-direction: column;
    }

    .merchant-title {
      font-weight: 700;
      color: #FFF;
      font-size: 0.95rem;
    }

    .merchant-timer {
      font-size: 0.75rem;
      color: #FFCC80;
    }

    .merchant-trade-btn {
      padding: 8px 20px;
      background: linear-gradient(135deg, #F4D03F 0%, #D4AC0D 100%);
      border: none;
      border-radius: 8px;
      font-weight: 700;
      color: #5D4037;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .merchant-trade-btn:hover {
      transform: scale(1.05);
    }

    /* Merchant Panel Overlay */
    .merchant-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .merchant-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .merchant-panel {
      width: 90%;
      max-width: 500px;
      background: linear-gradient(135deg, #5D4037 0%, #4E342E 100%);
      border-radius: 20px;
      border: 3px solid #8D6E63;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      overflow: hidden;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .merchant-overlay.visible .merchant-panel {
      transform: scale(1);
    }

    .merchant-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: rgba(0,0,0,0.2);
      border-bottom: 2px solid #8D6E63;
    }

    .merchant-face {
      font-size: 3rem;
    }

    .merchant-header-info h3 {
      color: #F4D03F;
      margin-bottom: 4px;
      font-size: 1.1rem;
    }

    .merchant-dialogue {
      color: #BCAAA4;
      font-size: 0.85rem;
      font-style: italic;
    }

    .merchant-timer-badge {
      margin-left: auto;
      padding: 8px 15px;
      background: linear-gradient(135deg, #FF7043 0%, #E64A19 100%);
      border-radius: 20px;
      color: #fff;
      font-weight: 700;
      font-size: 1.1rem;
    }

    /* Trade Rows */
    .trade-rows {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .trade-row {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 15px;
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      transition: all 0.2s;
    }

    .trade-row:hover:not(.disabled) {
      background: rgba(255,255,255,0.12);
    }

    .trade-row.disabled {
      opacity: 0.5;
    }

    .trade-resource {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 100px;
    }

    .trade-icon {
      font-size: 1.8rem;
    }

    .trade-info {
      display: flex;
      flex-direction: column;
    }

    .trade-name {
      font-weight: 700;
      color: #FFF;
      font-size: 0.9rem;
    }

    .trade-have {
      font-size: 0.7rem;
      color: #A99584;
    }

    .trade-price {
      text-align: center;
      min-width: 60px;
    }

    .price-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #F4D03F;
    }

    .price-label {
      display: block;
      font-size: 0.65rem;
      color: #A99584;
    }

    .trade-limit {
      text-align: center;
      min-width: 50px;
    }

    .limit-value {
      font-weight: 700;
      color: #FFCC80;
      font-size: 0.85rem;
    }

    .limit-label {
      display: block;
      font-size: 0.6rem;
      color: #A99584;
    }

    .trade-buttons {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }

    .trade-buttons button {
      padding: 6px 12px;
      background: linear-gradient(135deg, #7CB342 0%, #558B2F 100%);
      border: none;
      border-radius: 6px;
      color: #FFF;
      font-weight: 600;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .trade-buttons button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }

    .trade-buttons button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .merchant-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: rgba(0,0,0,0.2);
      border-top: 2px solid #8D6E63;
    }

    .merchant-tip {
      font-size: 0.75rem;
      color: #BCAAA4;
    }

    .btn-close {
      padding: 8px 20px;
      background: rgba(255,255,255,0.1);
      border: 2px solid #8D6E63;
      border-radius: 8px;
      color: #FFF;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-close:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Notification variant for merchant */
    .notification.merchant {
      background: linear-gradient(135deg, #8D6E63 0%, #6D4C41 100%);
      border: 2px solid #A1887F;
    }

    .notification.info {
      background: linear-gradient(135deg, #5C6BC0 0%, #3949AB 100%);
      color: #fff;
    }

    /* Market Trading Panel */
    .market-trading-panel {
      display: none;
      margin-top: 20px;
      background: linear-gradient(135deg, #5D4037 0%, #4E342E 100%);
      border-radius: 12px;
      border: 2px solid #8D6E63;
      overflow: hidden;
    }

    .market-trading-panel.visible {
      display: block;
    }

    .market-trading-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      background: rgba(0,0,0,0.2);
      font-weight: 700;
      color: #F4D03F;
    }

    .market-level {
      margin-left: auto;
      padding: 4px 10px;
      background: linear-gradient(135deg, #7CB342 0%, #558B2F 100%);
      border-radius: 10px;
      font-size: 0.75rem;
      color: #FFF;
    }

    .market-trades {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .market-row {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.06);
      border-radius: 8px;
    }

    .market-res {
      min-width: 80px;
      font-weight: 600;
      color: #FFF;
    }

    .market-price {
      color: #F4D03F;
      font-weight: 700;
      font-size: 0.9rem;
      min-width: 50px;
    }

    .market-btns {
      display: flex;
      gap: 5px;
      margin-left: auto;
    }

    .market-btns button {
      padding: 5px 10px;
      background: linear-gradient(135deg, #7CB342 0%, #558B2F 100%);
      border: none;
      border-radius: 5px;
      color: #FFF;
      font-weight: 600;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .market-btns button:hover:not(:disabled) {
      transform: translateY(-1px);
    }

    .market-btns button:disabled {
      background: #555;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <!-- Header -->
    <div class="header">
      <h1>üè∞ Medieval Tycoon</h1>
      <p>Build your village, harvest resources, grow your empire!</p>
    </div>
    
    <!-- Resource Bar -->
    <div class="resource-bar">
      <div class="resource">
        <span class="resource-icon">üí∞</span>
        <div class="resource-info">
          <span class="resource-name">Gold</span>
          <span class="resource-value" id="gold-value">50</span>
          <span class="resource-rate neutral" id="gold-rate">+0/s</span>
        </div>
      </div>
      <div class="resource">
        <span class="resource-icon">üåæ</span>
        <div class="resource-info">
          <span class="resource-name">Wheat</span>
          <span class="resource-value" id="wheat-value">0</span>
          <span class="resource-rate neutral" id="wheat-rate">+0/s</span>
        </div>
      </div>
      <div class="resource">
        <span class="resource-icon">‚õèÔ∏è</span>
        <div class="resource-info">
          <span class="resource-name">Stone</span>
          <span class="resource-value" id="stone-value">0</span>
          <span class="resource-rate neutral" id="stone-rate">+0/s</span>
        </div>
      </div>
      <div class="resource">
        <span class="resource-icon">üå≤</span>
        <div class="resource-info">
          <span class="resource-name">Wood</span>
          <span class="resource-value" id="wood-value">0</span>
          <span class="resource-rate neutral" id="wood-rate">+0/s</span>
        </div>
      </div>
      <!-- Royal Stipend Indicator -->
      <div class="stipend-indicator" id="stipend-indicator">
        <span>üëë</span>
        <span>Royal Stipend: +1üí∞/2s</span>
      </div>
    </div>
    
    <!-- Main 3-Column Layout -->
    <div class="main-layout">
      <!-- Left Panel - Tabbed (Inspect / Build) -->
      <div class="left-panel">
        <div class="left-tabbed-panel">
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchLeftTab('inspect')" title="Inspect">üîç</button>
            <button class="tab-btn" onclick="switchLeftTab('build')" title="Build">üî®</button>
          </div>

          <!-- Inspect Tab -->
          <div class="tab-content active" id="left-tab-inspect">
            <div class="building-info-empty" id="building-info-empty">
              üè† Hover over a building to see its details
            </div>
            <div class="building-info-content" id="building-info-content" style="display: none;">
              <div class="building-info-header">
                <span class="building-info-icon" id="info-icon">üåæ</span>
                <div class="building-info-title">
                  <h3 id="info-name">Building Name</h3>
                  <span class="level-text" id="info-level">Level 1</span>
                </div>
              </div>
              <div class="building-info-stats">
                <div class="info-stat-row">
                  <span class="info-stat-label">Status</span>
                  <span class="info-stat-value" id="info-status">Active</span>
                </div>
                <div class="info-stat-row" id="info-upgrade-row">
                  <span class="info-stat-label">Upgrade Cost</span>
                  <span class="info-stat-value" id="info-upgrade-cost">100 üí∞</span>
                </div>
              </div>
              <div class="info-production">
                <div class="info-production-title">Production (per second)</div>
                <div id="info-production-list">
                  <!-- Generated by JS -->
                </div>
              </div>
            </div>
          </div>

          <!-- Build Tab -->
          <div class="tab-content" id="left-tab-build">
            <div class="build-tab-header">
              Select a building to place:
            </div>
            <div class="build-list" id="build-list">
              <!-- Generated by JS -->
            </div>
            <div class="build-cancel" id="build-cancel" style="display: none;">
              <button class="btn btn-reset" onclick="cancelPlacement()">‚ùå Cancel</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Center Content -->
      <div class="center-content">
        <!-- Game World -->
        <div class="game-world" id="game-world">
          <div class="debug-grid"></div>
          <div class="ground-layer"></div>
          <div class="highlight-layer"></div>
          <!-- Buildings will be inserted here by JavaScript -->
        </div>

        <!-- Stats -->
        <div class="stats-panel">
          <div class="stat-box">
            <div class="stat-label">Buildings</div>
            <div class="stat-value" id="stat-buildings">0/9</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Total Levels</div>
            <div class="stat-value" id="stat-levels">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Net Worth</div>
            <div class="stat-value" id="stat-worth">50</div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="button-row">
          <button class="btn btn-reset" onclick="resetGame()">üîÑ Reset</button>
          <button class="btn btn-reset" onclick="toggleTiles()" id="toggle-tiles-btn">üôà Tiles</button>
          <button class="btn btn-reset" onclick="toggleDebugSliders()" id="toggle-sliders-btn">üîß Offsets</button>
          <button class="btn btn-reset" onclick="toggleDarkMode()" id="toggle-dark-btn">üåô Dark</button>
        </div>

        <!-- Debug Sliders (hidden by default) -->
        <div class="debug-sliders" id="debug-sliders" style="display: none;">
          <div style="font-size: 10px; color: #aaa; margin-bottom: 5px;">Building Offsets:</div>
          <div class="slider-group">
            <label>X Offset: <span id="x-offset-value">2</span>px</label>
            <input type="range" id="x-offset-slider" min="-50" max="50" value="2" step="1">
          </div>
          <div class="slider-group">
            <label>Y Offset: <span id="y-offset-value">-8</span>px</label>
            <input type="range" id="y-offset-slider" min="-50" max="50" value="-8" step="1">
          </div>
          <div class="slider-group">
            <label>Size Mult: <span id="size-mult-value">2.0</span></label>
            <input type="range" id="size-mult-slider" min="1.0" max="3.0" value="2.0" step="0.1">
          </div>
          <div style="font-size: 10px; color: #aaa; margin: 8px 0 5px;">Cursor Offsets:</div>
          <div class="slider-group">
            <label>Cursor X: <span id="cursor-x-value">-1</span>px</label>
            <input type="range" id="cursor-x-slider" min="-50" max="50" value="-1" step="1">
          </div>
          <div class="slider-group">
            <label>Cursor Y: <span id="cursor-y-value">-1</span>px</label>
            <input type="range" id="cursor-y-slider" min="-50" max="50" value="-1" step="1">
          </div>
          <button class="btn btn-reset" onclick="copyDebugValues()">üìã Copy Values</button>
        </div>
      </div>

      <!-- Right Panel - Tabbed Interface -->
      <div class="right-panel">
        <div class="tabbed-panel">
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('milestones')">üìú Milestones</button>
            <button class="tab-btn" onclick="switchTab('market')">üè™ Market</button>
          </div>

          <!-- Milestones Tab -->
          <div class="tab-content active" id="tab-milestones">
            <div class="milestone-progress-header">
              <span>Progress: </span>
              <span id="milestone-progress">0/8</span>
            </div>
            <div class="milestone-list" id="milestone-list">
              <!-- Generated by JS -->
            </div>
          </div>

          <!-- Market Tab -->
          <div class="tab-content" id="tab-market">
            <div class="market-status" id="market-status">
              <div class="market-locked">
                üîí Build a Market to unlock trading
              </div>
            </div>
            <div class="market-trading-content" id="market-trading-content" style="display: none;">
              <div class="market-level-display">
                <span>Market Level: </span>
                <span id="market-level">1</span>
              </div>
              <div class="market-trades" id="market-trades">
                <!-- Generated by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Notifications Container -->
  <div class="notifications" id="notifications"></div>

  <!-- Merchant Banner -->
  <div class="merchant-banner" id="merchant-banner">
    <div class="merchant-avatar">üß≥</div>
    <div class="merchant-info">
      <div class="merchant-title">Traveling Merchant</div>
      <div class="merchant-timer">Leaving in <span id="merchant-countdown">30</span>s</div>
    </div>
    <button class="merchant-trade-btn" onclick="openMerchantPanel()">Trade</button>
  </div>

  <!-- Merchant Trading Overlay -->
  <div class="merchant-overlay" id="merchant-overlay" onclick="closeMerchantPanel()">
    <div class="merchant-panel" onclick="event.stopPropagation()">
      <div class="merchant-header">
        <span class="merchant-face">üßî</span>
        <div class="merchant-header-info">
          <h3>Traveling Merchant</h3>
          <p class="merchant-dialogue" id="merchant-dialogue">"What would you like to sell today?"</p>
        </div>
        <div class="merchant-timer-badge">
          <span id="merchant-panel-countdown">30</span>s
        </div>
      </div>

      <div class="trade-rows" id="merchant-trade-rows">
        <!-- Generated by JS -->
      </div>

      <div class="merchant-footer">
        <span class="merchant-tip">üí° Build a Market for better prices!</span>
        <button class="btn-close" onclick="closeMerchantPanel()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // TILE GRID CONFIGURATION
    // Generated by Tile Calibrator
    // ==========================================
    // Scale factor to fit tiles in game world (adjust to zoom in/out)
    const TILE_SCALE = 0.35;

    const TILE_CONFIG = {
      // Full tile dimensions (including depth edge) - scaled
      tileWidth: 183 * TILE_SCALE,
      tileHeight: 191 * TILE_SCALE,

      // Grid diamond dimensions (flat top face only) - scaled
      gridWidth: 183 * TILE_SCALE,
      gridHeight: 113 * TILE_SCALE,

      // Depth edge (3D effect) - scaled
      depthHeight: 78 * TILE_SCALE,

      // Grid offset (if tile isn't centered) - scaled
      gridOffsetY: -47 * TILE_SCALE,

      // Grid size
      cols: 10,
      rows: 10,
    };

    // Tile type constants
    const TILE = {
      GRASS: 0,
      COBBLE: 1,
      DIRT: 2,
    };

    // Map array: 0=grass, 1=cobble, 2=dirt
    // Layout: 10 cols √ó 10 rows isometric grid
    const TILE_MAP = [
      //0  1  2  3  4  5  6  7  8  9
      [ 0, 0, 0, 0, 1, 1, 0, 0, 0, 0 ],  // Row 0
      [ 0, 0, 0, 1, 1, 1, 1, 0, 0, 0 ],  // Row 1
      [ 0, 0, 1, 1, 1, 1, 1, 1, 0, 0 ],  // Row 2
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],  // Row 3
      [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 ],  // Row 4 - center
      [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 ],  // Row 5 - center
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],  // Row 6
      [ 0, 0, 1, 1, 1, 1, 1, 1, 0, 0 ],  // Row 7
      [ 0, 0, 0, 1, 1, 1, 1, 0, 0, 0 ],  // Row 8
      [ 0, 0, 0, 0, 1, 1, 0, 0, 0, 0 ],  // Row 9
    ];

    // ==========================================
    // ASSET CONFIGURATION
    // ==========================================
    // Update these paths to point to your asset files
    const ASSETS = {
      // Ground tiles
      ground: 'assets/ground_basic.png',
      cobble: 'assets/cobble_basic.png',
      dirt: 'assets/dirt_basic.png',
      
      // Buildings - organized by type and level
      wheat_farm: {
        1: 'assets/wheat_basic_young.png',
        2: 'assets/wheat_basic_young.png', // Replace with lv2 when ready
        3: 'assets/wheat_basic_young.png', // Replace with lv3 when ready
        4: 'assets/wheat_basic_young.png', // Replace with lv4 when ready
      },
      quarry: {
        1: 'assets/quarry_basic.png',
        2: 'assets/quarry_basic.png',
        3: 'assets/quarry_basic.png',
        4: 'assets/quarry_basic.png',
      },
      lumber: {
        1: 'assets/lumber_basic.png',
        2: 'assets/lumber_basic.png',
        3: 'assets/lumber_basic.png',
        4: 'assets/lumber_basic.png',
      },
      bakery: {
        1: 'assets/bakery_basic.png',
        2: 'assets/bakery_basic.png',
        3: 'assets/bakery_basic.png',
        4: 'assets/bakery_basic.png',
      },
      blacksmith: {
        1: 'assets/blacksmith_basic.png',
        2: 'assets/blacksmith_basic.png',
        3: 'assets/blacksmith_basic.png',
        4: 'assets/blacksmith_basic.png',
      },
      market: {
        1: 'assets/market_basic.png',
        2: 'assets/market_basic.png',
        3: 'assets/market_basic.png',
        4: 'assets/market_basic.png',
      },
      townhall: {
        1: 'assets/town_hall_basic.png',
        2: 'assets/town_hall_basic.png',
        3: 'assets/town_hall_basic.png',
      },
      barn: {
        1: 'assets/barn_basic.png',
        2: 'assets/barn_basic.png',
        3: 'assets/barn_basic.png',
      },
    };
    
    // Fallback emojis when assets aren't available
    const EMOJI_FALLBACKS = {
      wheat_farm: 'üåæ',
      quarry: '‚õèÔ∏è',
      lumber: 'ü™ì',
      bakery: 'ü•ñ',
      blacksmith: '‚öíÔ∏è',
      market: 'üè™',
      townhall: 'üèõÔ∏è',
      barn: 'üèöÔ∏è',
    };

    // ==========================================
    // GAME CONFIGURATION
    // ==========================================
    const BUILDINGS = {
      wheat_farm: {
        name: 'Wheat Farm',
        baseCost: { gold: 10 },
        production: { wheat: 1 },
        upgrades: [
          { cost: { gold: 50 }, mult: 2 },
          { cost: { gold: 200 }, mult: 3 },
          { cost: { gold: 800 }, mult: 5 },
        ],
        unlockReq: null,
      },
      quarry: {
        name: 'Stone Quarry',
        baseCost: { gold: 25 },
        production: { stone: 1 },
        upgrades: [
          { cost: { gold: 100 }, mult: 2 },
          { cost: { gold: 400 }, mult: 3 },
          { cost: { gold: 1500 }, mult: 5 },
        ],
        unlockReq: { wheat: 10 },
      },
      lumber: {
        name: 'Lumber Camp',
        baseCost: { gold: 40 },
        production: { wood: 1 },
        upgrades: [
          { cost: { gold: 150 }, mult: 2 },
          { cost: { gold: 500 }, mult: 3 },
          { cost: { gold: 2000 }, mult: 5 },
        ],
        unlockReq: { stone: 5 },
      },
      bakery: {
        name: 'Bakery',
        baseCost: { gold: 100, wheat: 20 },
        production: { gold: 3 },
        consumes: { wheat: 1 },
        upgrades: [
          { cost: { gold: 300 }, mult: 2 },
          { cost: { gold: 1000 }, mult: 3 },
          { cost: { gold: 4000 }, mult: 5 },
        ],
        unlockReq: { wheat: 30 },
      },
      blacksmith: {
        name: 'Blacksmith',
        baseCost: { gold: 200, stone: 30, wood: 20 },
        production: { gold: 8 },
        consumes: { stone: 1, wood: 1 },
        upgrades: [
          { cost: { gold: 600 }, mult: 2 },
          { cost: { gold: 2000 }, mult: 3 },
          { cost: { gold: 8000 }, mult: 5 },
        ],
        unlockReq: { stone: 50, wood: 30 },
      },
      market: {
        name: 'Market',
        baseCost: { gold: 500, wood: 50 },
        production: { gold: 15 },
        upgrades: [
          { cost: { gold: 1500 }, mult: 2 },
          { cost: { gold: 5000 }, mult: 3 },
          { cost: { gold: 20000 }, mult: 5 },
        ],
        unlockReq: { gold: 300 },
      },
      townhall: {
        name: 'Town Hall',
        baseCost: { gold: 2000, stone: 100, wood: 100 },
        production: { gold: 50 },
        upgrades: [
          { cost: { gold: 8000 }, mult: 2 },
          { cost: { gold: 30000 }, mult: 3 },
        ],
        unlockReq: { gold: 1000, stone: 80, wood: 80 },
      },
      barn: {
        name: 'Barn',
        baseCost: { gold: 75, wood: 15 },
        production: {},
        storageBonus: 100,
        upgrades: [
          { cost: { gold: 200 }, mult: 2 },
          { cost: { gold: 600 }, mult: 3 },
        ],
        unlockReq: { wood: 10 },
      },
    };

    // ==========================================
    // MILESTONE CONFIGURATION
    // ==========================================
    const MILESTONES = {
      first_farm: {
        name: "First Harvest",
        description: "Build your first Wheat Farm",
        condition: (res, bldgs) => countBuildings(bldgs, 'wheat_farm') >= 1,
        reward: { gold: 15 },
        icon: 'üå±'
      },
      second_farm: {
        name: "Expanding Fields",
        description: "Build a second Wheat Farm",
        condition: (res, bldgs) => countBuildings(bldgs, 'wheat_farm') >= 2,
        reward: { gold: 10 },
        icon: 'üåæ'
      },
      wheat_10: {
        name: "First Stockpile",
        description: "Accumulate 10 wheat",
        condition: (res, bldgs) => res.wheat >= 10,
        reward: { gold: 20 },
        icon: 'üì¶'
      },
      first_quarry: {
        name: "Breaking Ground",
        description: "Build a Stone Quarry",
        condition: (res, bldgs) => countBuildings(bldgs, 'quarry') >= 1,
        reward: { gold: 25 },
        icon: '‚õèÔ∏è'
      },
      stone_5: {
        name: "Solid Foundation",
        description: "Accumulate 5 stone",
        condition: (res, bldgs) => res.stone >= 5,
        reward: { gold: 15 },
        icon: 'ü™®'
      },
      first_lumber: {
        name: "Into the Woods",
        description: "Build a Lumber Camp",
        condition: (res, bldgs) => countBuildings(bldgs, 'lumber') >= 1,
        reward: { gold: 30 },
        icon: 'ü™ì'
      },
      wheat_30: {
        name: "Bread Basket",
        description: "Accumulate 30 wheat",
        condition: (res, bldgs) => res.wheat >= 30,
        reward: { gold: 50 },
        icon: 'üß∫'
      },
      first_bakery: {
        name: "Self-Sufficient!",
        description: "Build a Bakery and start producing gold",
        condition: (res, bldgs) => countBuildings(bldgs, 'bakery') >= 1,
        reward: { gold: 100 },
        icon: 'ü•ñ'
      }
    };

    // ==========================================
    // MERCHANT & MARKET CONFIGURATION
    // ==========================================
    const MERCHANT_CONFIG = {
      firstAppearDelay: 60000,      // 60 sec before first visit
      minInterval: 45000,           // Min time between visits
      maxInterval: 90000,           // Max time between visits
      visitDuration: 30000,         // How long merchant stays

      prices: {
        wheat: 2,
        stone: 3,
        wood: 3
      },

      maxPerVisit: {
        wheat: 20,
        stone: 15,
        wood: 15
      }
    };

    const MARKET_CONFIG = {
      prices: {
        wheat: 3,
        stone: 5,
        wood: 5
      }
      // No quantity limits for market
    };

    // Convert grid coordinates to screen position (isometric projection)
    function gridToScreen(gridX, gridY) {
      const { gridWidth, gridHeight, cols, rows } = TILE_CONFIG;

      // Get actual game world dimensions
      const world = document.getElementById('game-world');
      const worldCenterX = world.offsetWidth / 2;
      const worldCenterY = world.offsetHeight / 2;

      // Calculate center of grid (middle tile)
      const centerGridX = (cols - 1) / 2;
      const centerGridY = (rows - 1) / 2;

      // Offset so center of grid is at center of world
      const offsetX = worldCenterX - (centerGridX - centerGridY) * (gridWidth / 2);
      const offsetY = worldCenterY - (centerGridX + centerGridY) * (gridHeight / 2);

      return {
        x: offsetX + (gridX - gridY) * (gridWidth / 2),
        y: offsetY + (gridX + gridY) * (gridHeight / 2),
        z: (gridX + gridY) * 10
      };
    }

    // Cursor detection offsets (to align cursor with visual tile positions)
    let cursorOffsetX = -1;
    let cursorOffsetY = -1;

    // Convert screen (pixel) coordinates to grid coordinates
    // Returns { col, row } - may be fractional, use Math.floor for tile index
    function screenToGrid(screenX, screenY) {
      const { gridWidth, gridHeight, cols, rows } = TILE_CONFIG;

      // Apply cursor offset to compensate for visual tile displacement
      screenX += cursorOffsetX;
      screenY += cursorOffsetY;

      // Get actual game world dimensions
      const world = document.getElementById('game-world');
      const worldCenterX = world.offsetWidth / 2;
      const worldCenterY = world.offsetHeight / 2;

      // Calculate center of grid (middle tile)
      const centerGridX = (cols - 1) / 2;
      const centerGridY = (rows - 1) / 2;

      // Same offsets as gridToScreen
      const offsetX = worldCenterX - (centerGridX - centerGridY) * (gridWidth / 2);
      const offsetY = worldCenterY - (centerGridX + centerGridY) * (gridHeight / 2);

      // Reverse the isometric transformation
      // x = offsetX + (gridX - gridY) * (gridWidth / 2)
      // y = offsetY + (gridX + gridY) * (gridHeight / 2)
      // Solving for gridX and gridY:
      const A = (screenX - offsetX) / (gridWidth / 2);  // = gridX - gridY
      const B = (screenY - offsetY) / (gridHeight / 2); // = gridX + gridY

      const gridX = (A + B) / 2;  // col
      const gridY = (B - A) / 2;  // row

      return { col: gridX, row: gridY };
    }

    // Building footprint size (2x2 tiles)
    const BUILDING_FOOTPRINT = 2;

    // ==========================================
    // NEW BUILDING SYSTEM - Dynamic Placement
    // ==========================================
    // Buildings stored as array: { type, row, col, level }
    let placedBuildings = [];

    // Get set of tile positions occupied by built buildings
    // Returns a Set of "row,col" strings for quick lookup
    function getOccupiedTiles() {
      const occupied = new Set();
      placedBuildings.forEach(building => {
        // Mark all tiles in the building's 2x2 footprint as occupied
        for (let dr = 0; dr < BUILDING_FOOTPRINT; dr++) {
          for (let dc = 0; dc < BUILDING_FOOTPRINT; dc++) {
            occupied.add(`${building.row + dr},${building.col + dc}`);
          }
        }
      });
      return occupied;
    }

    // Check if a 2x2 area starting at (row, col) is valid for placement
    function canPlaceAt(row, col) {
      const { rows, cols } = TILE_CONFIG;

      // Check bounds - building needs 2x2 space
      if (row < 0 || col < 0 || row + BUILDING_FOOTPRINT > rows || col + BUILDING_FOOTPRINT > cols) {
        return false;
      }

      // Check for collisions with existing buildings
      const occupied = getOccupiedTiles();
      for (let dr = 0; dr < BUILDING_FOOTPRINT; dr++) {
        for (let dc = 0; dc < BUILDING_FOOTPRINT; dc++) {
          if (occupied.has(`${row + dr},${col + dc}`)) {
            return false;
          }
        }
      }

      return true;
    }

    // Place a building at the specified grid position
    function placeBuilding(type, row, col) {
      const def = BUILDINGS[type];
      if (!def) return false;

      // Check if we can afford it
      if (!canAfford(def.baseCost)) {
        notify(`Not enough resources to build ${def.name}!`, 'error');
        return false;
      }

      // Check if placement is valid
      if (!canPlaceAt(row, col)) {
        notify('Cannot place building here!', 'error');
        return false;
      }

      // Deduct cost
      Object.entries(def.baseCost).forEach(([res, amt]) => {
        resources[res] -= amt;
      });

      // Add building
      placedBuildings.push({
        type: type,
        row: row,
        col: col,
        level: 0
      });

      notify(`${def.name} built!`, 'success');

      // Check if this gold-producing building ends the stipend
      if (['bakery', 'blacksmith', 'market', 'townhall'].includes(type)) {
        checkStipendStatus();
      }

      // If Market is built, disable the traveling merchant
      if (type === 'market') {
        disableMerchant();
        notify('Market built! You now have permanent access to trading.', 'success');
      }

      // Check building milestones immediately
      checkMilestones();

      updateUI();
      return true;
    }

    // Find building at a specific grid position
    function getBuildingAt(row, col) {
      return placedBuildings.find(b =>
        row >= b.row && row < b.row + BUILDING_FOOTPRINT &&
        col >= b.col && col < b.col + BUILDING_FOOTPRINT
      );
    }

    // Convert grid (row, col) to pixel position for buildings
    // Buildings occupy a 2x2 area, so we center on the middle of the 4 tiles
    // isBuilt: true for constructed buildings (use debug offsets), false for placeholders (compact UI)
    function gridToPixel(row, col, isBuilt = false) {
      const { tileHeight, gridWidth, gridHeight } = TILE_CONFIG;

      // For 2x2 footprint, center is at (col + 0.5, row + 0.5) in grid coords
      const centerCol = col + (BUILDING_FOOTPRINT - 1) / 2;
      const centerRow = row + (BUILDING_FOOTPRINT - 1) / 2;

      // Get screen position of the center point
      const pos = gridToScreen(centerCol, centerRow);

      if (isBuilt) {
        // Built buildings use debug offsets for fine-tuning
        const buildingSize = gridWidth * debugSizeMult;
        const x = pos.x - buildingSize / 2 + debugOffsetX;
        const y = pos.y + (tileHeight / 2) - buildingSize / 2 + debugOffsetY;
        // Higher z-index for built buildings to appear above tiles
        const frontZ = (col + BUILDING_FOOTPRINT + row + BUILDING_FOOTPRINT) * 10 + 100;
        return { x, y, z: frontZ };
      } else {
        // Placeholders use compact positioning (original behavior)
        const placeholderSize = 42;
        const x = pos.x - placeholderSize / 2;
        const y = pos.y + (tileHeight / 2) - placeholderSize / 2;
        const frontZ = (col + BUILDING_FOOTPRINT + row + BUILDING_FOOTPRINT) * 10;
        return { x, y, z: frontZ };
      }
    }

    // Old SLOTS system removed - buildings are now placed dynamically via placedBuildings[]

    // ==========================================
    // DEBUG OFFSETS (adjustable via sliders)
    // ==========================================
    let debugOffsetX = 2;
    let debugOffsetY = -8;
    let debugSizeMult = 2;

    // ==========================================
    // GAME STATE
    // ==========================================
    let resources = { gold: 50, wheat: 0, stone: 0, wood: 0 };
    // Buildings are now tracked in placedBuildings[] array (defined in PLACEMENT section)

    // Royal Stipend state
    let royalStipend = {
      active: true,           // Currently receiving stipend
      totalReceived: 0,       // Tracking for stats/achievements
      endReason: null         // 'bakery' | 'blacksmith' | 'market' | 'townhall'
    };

    // Milestone tracking
    let completedMilestones = new Set();

    // Merchant state
    let merchant = {
      active: false,                // Is merchant currently visiting?
      visitStartTime: null,         // When current visit started
      soldThisVisit: {              // Track sales per visit for limits
        wheat: 0,
        stone: 0,
        wood: 0
      },
      nextVisitTime: null,          // Scheduled next arrival
      totalVisits: 0,               // Stats tracking
      disabled: false,              // True once Market is built
      visitTimeout: null,           // Reference to departure timeout
      nextVisitTimeout: null        // Reference to next visit timeout
    };

    let merchantTimerInterval = null;

    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return Math.floor(num).toString();
    }

    function canAfford(cost) {
      return Object.entries(cost).every(([res, amt]) => resources[res] >= amt);
    }

    function isUnlocked(req) {
      if (!req) return true;
      return Object.entries(req).every(([res, amt]) => resources[res] >= amt);
    }

    function spendResources(cost) {
      Object.entries(cost).forEach(([res, amt]) => {
        resources[res] -= amt;
      });
    }

    function notify(message, type = 'success') {
      const container = document.getElementById('notifications');
      const div = document.createElement('div');
      div.className = `notification ${type}`;
      div.textContent = message;
      container.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // ==========================================
    // ROYAL STIPEND FUNCTIONS
    // ==========================================
    function hasGoldProduction() {
      // Returns true if player has ANY gold-producing building
      const goldProducers = ['bakery', 'blacksmith', 'market', 'townhall'];

      return placedBuildings.some((building) => {
        return goldProducers.includes(building.type);
      });
    }

    function checkStipendStatus() {
      if (!royalStipend.active) return;

      if (hasGoldProduction()) {
        royalStipend.active = false;
        // Find which building ended it (for flavor text)
        placedBuildings.forEach((building) => {
          if (['bakery', 'blacksmith', 'market', 'townhall'].includes(building.type)) {
            royalStipend.endReason = building.type;
          }
        });
        notify("The King's stipend has ended. You're self-sufficient now! üëë", 'success');
        updateStipendIndicator();
      }
    }

    function stipendTick() {
      if (!royalStipend.active) return;

      resources.gold += 1;
      royalStipend.totalReceived += 1;
    }

    function updateStipendIndicator() {
      const indicator = document.getElementById('stipend-indicator');
      if (royalStipend.active) {
        indicator.classList.remove('inactive');
      } else {
        indicator.classList.add('inactive');
      }
    }

    // ==========================================
    // MILESTONE FUNCTIONS
    // ==========================================
    function countBuildings(bldgs, type) {
      return bldgs.filter((b) => b.type === type).length;
    }

    function grantReward(reward) {
      Object.entries(reward).forEach(([res, amt]) => {
        resources[res] += amt;
      });
    }

    function checkMilestones() {
      let anyCompleted = false;

      Object.entries(MILESTONES).forEach(([id, milestone]) => {
        // Skip already completed
        if (completedMilestones.has(id)) return;

        // Check condition
        if (milestone.condition(resources, placedBuildings)) {
          completedMilestones.add(id);
          grantReward(milestone.reward);
          showMilestonePopup(milestone);
          anyCompleted = true;
        }
      });

      if (anyCompleted) {
        updateMilestonePanel();
      }
    }

    function showMilestonePopup(milestone) {
      const rewardText = Object.entries(milestone.reward)
        .map(([res, amt]) => `+${amt} ${res === 'gold' ? 'üí∞' : res === 'wheat' ? 'üåæ' : res === 'stone' ? '‚õèÔ∏è' : 'üå≤'}`)
        .join(' ');

      notify(`${milestone.icon} ${milestone.name}! ${rewardText}`, 'milestone');
    }

    function updateMilestonePanel() {
      const list = document.getElementById('milestone-list');
      const progress = document.getElementById('milestone-progress');

      list.innerHTML = Object.entries(MILESTONES).map(([id, m]) => {
        const done = completedMilestones.has(id);
        const rewardText = Object.entries(m.reward)
          .map(([r, a]) => `+${a}${r === 'gold' ? 'üí∞' : ''}`)
          .join(' ');

        return `
          <div class="milestone-item ${done ? 'completed' : ''}">
            <span class="milestone-icon">${done ? '‚úÖ' : m.icon}</span>
            <div class="milestone-info">
              <div class="milestone-name">${m.name}</div>
              <div class="milestone-desc">${m.description}</div>
            </div>
            <div class="milestone-reward">${rewardText}</div>
          </div>
        `;
      }).join('');

      progress.textContent = `${completedMilestones.size}/${Object.keys(MILESTONES).length}`;
    }

    let milestonePanelCollapsed = false;
    function toggleMilestonePanel() {
      const list = document.getElementById('milestone-list');
      milestonePanelCollapsed = !milestonePanelCollapsed;
      if (milestonePanelCollapsed) {
        list.classList.add('collapsed');
      } else {
        list.classList.remove('collapsed');
      }
    }

    // ==========================================
    // MERCHANT FUNCTIONS
    // ==========================================
    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function scheduleMerchantVisit(isFirst = false) {
      if (merchant.disabled) return;

      // Clear any existing timeout
      if (merchant.nextVisitTimeout) {
        clearTimeout(merchant.nextVisitTimeout);
      }

      const delay = isFirst
        ? MERCHANT_CONFIG.firstAppearDelay
        : randomBetween(MERCHANT_CONFIG.minInterval, MERCHANT_CONFIG.maxInterval);

      merchant.nextVisitTime = Date.now() + delay;

      merchant.nextVisitTimeout = setTimeout(() => {
        if (!merchant.disabled) {
          merchantArrives();
        }
      }, delay);
    }

    function merchantArrives() {
      merchant.active = true;
      merchant.visitStartTime = Date.now();
      merchant.soldThisVisit = { wheat: 0, stone: 0, wood: 0 };
      merchant.totalVisits++;

      // Show merchant UI
      showMerchantBanner();
      notify('üß≥ A traveling merchant has arrived!', 'merchant');

      // Start countdown timer
      startMerchantCountdown();

      // Schedule departure
      merchant.visitTimeout = setTimeout(() => {
        merchantDeparts();
      }, MERCHANT_CONFIG.visitDuration);
    }

    function merchantDeparts() {
      if (!merchant.active) return;

      merchant.active = false;
      hideMerchantBanner();
      closeMerchantPanel();
      stopMerchantCountdown();
      notify("üëã The merchant has left. They'll return soon...", 'info');

      // Schedule next visit
      scheduleMerchantVisit();
    }

    function disableMerchant() {
      merchant.disabled = true;
      merchant.active = false;

      // Clear timeouts
      if (merchant.visitTimeout) {
        clearTimeout(merchant.visitTimeout);
      }
      if (merchant.nextVisitTimeout) {
        clearTimeout(merchant.nextVisitTimeout);
      }

      hideMerchantBanner();
      closeMerchantPanel();
      stopMerchantCountdown();
    }

    function showMerchantBanner() {
      document.getElementById('merchant-banner').classList.add('visible');
    }

    function hideMerchantBanner() {
      const banner = document.getElementById('merchant-banner');
      banner.classList.remove('visible');
      banner.classList.remove('urgent');
    }

    function openMerchantPanel() {
      if (!merchant.active) return;
      renderMerchantTradeRows();
      document.getElementById('merchant-overlay').classList.add('visible');
    }

    function closeMerchantPanel() {
      document.getElementById('merchant-overlay').classList.remove('visible');
    }

    function startMerchantCountdown() {
      if (merchantTimerInterval) clearInterval(merchantTimerInterval);

      const updateCountdown = () => {
        if (!merchant.active) {
          clearInterval(merchantTimerInterval);
          return;
        }

        const elapsed = Date.now() - merchant.visitStartTime;
        const remaining = Math.max(0, Math.ceil((MERCHANT_CONFIG.visitDuration - elapsed) / 1000));

        const countdownEl = document.getElementById('merchant-countdown');
        const panelCountdownEl = document.getElementById('merchant-panel-countdown');

        if (countdownEl) countdownEl.textContent = remaining;
        if (panelCountdownEl) panelCountdownEl.textContent = remaining;

        if (remaining <= 10) {
          document.getElementById('merchant-banner').classList.add('urgent');
        }
      };

      updateCountdown();
      merchantTimerInterval = setInterval(updateCountdown, 1000);
    }

    function stopMerchantCountdown() {
      if (merchantTimerInterval) {
        clearInterval(merchantTimerInterval);
        merchantTimerInterval = null;
      }
    }

    function renderMerchantTradeRows() {
      const container = document.getElementById('merchant-trade-rows');
      const config = MERCHANT_CONFIG;

      const resourceEmoji = { wheat: 'üåæ', stone: '‚õèÔ∏è', wood: 'üå≤' };

      container.innerHTML = ['wheat', 'stone', 'wood'].map(res => {
        const have = resources[res];
        const sold = merchant.soldThisVisit[res];
        const maxPerVisit = config.maxPerVisit[res];
        const remaining = maxPerVisit - sold;
        const price = config.prices[res];
        const canSell = Math.min(have, remaining);

        return `
          <div class="trade-row ${canSell === 0 ? 'disabled' : ''}">
            <div class="trade-resource">
              <span class="trade-icon">${resourceEmoji[res]}</span>
              <div class="trade-info">
                <span class="trade-name">${capitalize(res)}</span>
                <span class="trade-have">You have: ${have}</span>
              </div>
            </div>

            <div class="trade-price">
              <span class="price-value">${price}</span>
              <span class="price-label">üí∞ each</span>
            </div>

            <div class="trade-limit">
              <span class="limit-value">${remaining}/${maxPerVisit}</span>
              <span class="limit-label">left</span>
            </div>

            <div class="trade-buttons">
              <button onclick="sellToMerchant('${res}', 1)" ${canSell < 1 ? 'disabled' : ''}>Sell 1</button>
              <button onclick="sellToMerchant('${res}', 5)" ${canSell < 5 ? 'disabled' : ''}>Sell 5</button>
              <button onclick="sellToMerchant('${res}', ${canSell})" ${canSell === 0 ? 'disabled' : ''}>Sell All</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function sellToMerchant(resource, amount = 1) {
      if (!merchant.active) return false;

      const config = MERCHANT_CONFIG;
      const maxCanSell = config.maxPerVisit[resource] - merchant.soldThisVisit[resource];
      const actualAmount = Math.min(amount, maxCanSell, resources[resource]);

      if (actualAmount <= 0) {
        if (resources[resource] <= 0) {
          notify(`No ${resource} to sell!`, 'error');
        } else {
          notify(`Merchant won't buy more ${resource} this visit!`, 'error');
        }
        return false;
      }

      const goldEarned = actualAmount * config.prices[resource];

      resources[resource] -= actualAmount;
      resources.gold += goldEarned;
      merchant.soldThisVisit[resource] += actualAmount;

      notify(`Sold ${actualAmount} ${resource} for ${goldEarned} gold!`, 'success');
      updateUI();
      renderMerchantTradeRows();

      return true;
    }

    // ==========================================
    // MARKET TRADING FUNCTIONS
    // ==========================================
    function hasMarket() {
      return placedBuildings.some((building) => building.type === 'market');
    }

    function getMarketLevel() {
      const market = placedBuildings.find((b) => b.type === 'market');
      return market ? market.level + 1 : 0;
    }

    function sellAtMarket(resource, amount = 1) {
      if (!hasMarket()) return false;

      const actualAmount = Math.min(amount, resources[resource]);

      if (actualAmount <= 0) {
        notify(`No ${resource} to sell!`, 'error');
        return false;
      }

      // Market level boosts prices: +10% per upgrade level
      const levelBonus = 1 + (getMarketLevel() - 1) * 0.1;
      const basePrice = MARKET_CONFIG.prices[resource];
      const finalPrice = Math.floor(basePrice * levelBonus);
      const goldEarned = actualAmount * finalPrice;

      resources[resource] -= actualAmount;
      resources.gold += goldEarned;

      notify(`Sold ${actualAmount} ${resource} for ${goldEarned} gold!`, 'success');
      updateUI();
      updateMarketTradingPanel();

      return true;
    }

    function updateMarketTradingPanel() {
      const marketStatus = document.getElementById('market-status');
      const marketContent = document.getElementById('market-trading-content');

      if (!hasMarket()) {
        // Show locked message
        marketStatus.style.display = 'block';
        marketContent.style.display = 'none';
        return;
      }

      // Show trading UI
      marketStatus.style.display = 'none';
      marketContent.style.display = 'block';

      const level = getMarketLevel();
      const levelBonus = 1 + (level - 1) * 0.1;

      document.getElementById('market-level').textContent = level;

      const container = document.getElementById('market-trades');
      const resourceEmoji = { wheat: 'üåæ', stone: '‚õèÔ∏è', wood: 'üå≤' };

      container.innerHTML = ['wheat', 'stone', 'wood'].map(res => {
        const have = resources[res];
        const basePrice = MARKET_CONFIG.prices[res];
        const finalPrice = Math.floor(basePrice * levelBonus);

        return `
          <div class="market-row">
            <span class="market-res">${resourceEmoji[res]} ${have}</span>
            <span class="market-price">${finalPrice}üí∞</span>
            <div class="market-btns">
              <button onclick="sellAtMarket('${res}', 1)" ${have < 1 ? 'disabled' : ''}>1</button>
              <button onclick="sellAtMarket('${res}', 10)" ${have < 10 ? 'disabled' : ''}>10</button>
              <button onclick="sellAtMarket('${res}', ${have})" ${have === 0 ? 'disabled' : ''}>All</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ==========================================
    // GAME LOGIC
    // ==========================================
    function calculateProduction() {
      const production = { gold: 0, wheat: 0, stone: 0, wood: 0 };

      placedBuildings.forEach(building => {
        const def = BUILDINGS[building.type];
        const mult = building.level > 0 ? def.upgrades[building.level - 1].mult : 1;

        // Check if we can produce (have resources to consume)
        let canProduce = true;
        if (def.consumes) {
          canProduce = Object.entries(def.consumes).every(([res, amt]) => resources[res] >= amt);
        }

        if (canProduce) {
          Object.entries(def.production).forEach(([res, amt]) => {
            production[res] += amt * mult;
          });
          if (def.consumes) {
            Object.entries(def.consumes).forEach(([res, amt]) => {
              production[res] -= amt;
            });
          }
        }
      });

      return production;
    }

    function tick() {
      placedBuildings.forEach((building) => {
        const def = BUILDINGS[building.type];
        if (!def) return;

        const mult = building.level > 0 ? def.upgrades[building.level - 1].mult : 1;

        let canProduce = true;
        if (def.consumes) {
          canProduce = Object.entries(def.consumes).every(([res, amt]) => resources[res] >= amt);
          if (canProduce) {
            Object.entries(def.consumes).forEach(([res, amt]) => {
              resources[res] -= amt;
            });
          }
        }

        if (canProduce) {
          Object.entries(def.production).forEach(([res, amt]) => {
            resources[res] += amt * mult;
          });
        }
      });

      // Check resource-based milestones after production
      checkMilestones();

      updateUI();
    }

    // Old buildOrUpgrade removed - now using placeBuilding() and upgradeBuilding()

    function resetGame() {
      resources = { gold: 50, wheat: 0, stone: 0, wood: 0 };
      placedBuildings = [];

      // Reset Royal Stipend
      royalStipend = { active: true, totalReceived: 0, endReason: null };
      updateStipendIndicator();

      // Reset Milestones
      completedMilestones = new Set();
      updateMilestonePanel();

      // Reset Merchant
      if (merchant.visitTimeout) clearTimeout(merchant.visitTimeout);
      if (merchant.nextVisitTimeout) clearTimeout(merchant.nextVisitTimeout);
      if (merchantTimerInterval) clearInterval(merchantTimerInterval);
      merchant = {
        active: false,
        visitStartTime: null,
        soldThisVisit: { wheat: 0, stone: 0, wood: 0 },
        nextVisitTime: null,
        totalVisits: 0,
        disabled: false,
        visitTimeout: null,
        nextVisitTimeout: null
      };
      hideMerchantBanner();
      closeMerchantPanel();
      scheduleMerchantVisit(true);

      // Reset Market Trading Panel
      updateMarketTradingPanel();

      notify('Game reset!');
      updateUI();
    }

    // Toggle tile visibility for debugging
    let tilesVisible = true;
    function toggleTiles() {
      const groundLayer = document.querySelector('.ground-layer');
      const btn = document.getElementById('toggle-tiles-btn');
      tilesVisible = !tilesVisible;
      groundLayer.style.display = tilesVisible ? 'block' : 'none';
      btn.textContent = tilesVisible ? 'üôà Tiles' : 'üëÅÔ∏è Tiles';
    }

    // Toggle debug sliders visibility
    let slidersVisible = false;
    function toggleDebugSliders() {
      const sliders = document.getElementById('debug-sliders');
      const btn = document.getElementById('toggle-sliders-btn');
      slidersVisible = !slidersVisible;
      sliders.style.display = slidersVisible ? 'block' : 'none';
      btn.textContent = slidersVisible ? 'üîß Hide' : 'üîß Offsets';
    }

    // Toggle dark mode for game world background
    let darkModeEnabled = false;
    function toggleDarkMode() {
      const world = document.getElementById('game-world');
      const btn = document.getElementById('toggle-dark-btn');
      darkModeEnabled = !darkModeEnabled;
      if (darkModeEnabled) {
        world.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%)';
      } else {
        world.style.background = 'linear-gradient(135deg, #7CB342 0%, #558B2F 50%, #33691E 100%)';
      }
      btn.textContent = darkModeEnabled ? '‚òÄÔ∏è Light' : 'üåô Dark';
    }

    // ==========================================
    // UI RENDERING
    // ==========================================

    // Debug grid - draws isometric grid lines
    function renderDebugGrid() {
      const world = document.getElementById('game-world');
      const debugGrid = world.querySelector('.debug-grid');
      debugGrid.innerHTML = '';

      const { gridWidth, gridHeight, rows, cols } = TILE_CONFIG;

      // Calculate isometric angle from grid dimensions
      // For 2:1 isometric: angle = atan(gridHeight/2 / gridWidth/2) = atan(0.5)
      const angle = Math.atan(gridHeight / gridWidth) * (180 / Math.PI);

      // Calculate line length based on the diagonal of the game world
      // Game world is 900x500, so diagonal is about 1030px, but we need extra for angled lines
      const lineLength = 1500;

      // Extended range to ensure full coverage of 900x500 game world
      const extendedRange = Math.max(rows, cols) * 2;

      // Draw lines going down-right (positive slope in screen coords)
      // These lines run from top-left to bottom-right direction
      for (let i = -extendedRange; i <= extendedRange; i++) {
        const startPos = gridToScreen(0, i);
        const line = document.createElement('div');
        line.className = 'debug-line';
        line.style.width = `${lineLength}px`;
        // Center the line on the grid intersection point
        line.style.left = `${startPos.x - lineLength / 2}px`;
        line.style.top = `${startPos.y}px`;
        line.style.transform = `rotate(${angle}deg)`;
        line.style.transformOrigin = 'center center';
        debugGrid.appendChild(line);
      }

      // Draw lines going down-left (negative slope in screen coords)
      // These lines run from top-right to bottom-left direction
      for (let i = -extendedRange; i <= extendedRange; i++) {
        const startPos = gridToScreen(i, 0);
        const line = document.createElement('div');
        line.className = 'debug-line';
        line.style.width = `${lineLength}px`;
        // Center the line on the grid intersection point
        line.style.left = `${startPos.x - lineLength / 2}px`;
        line.style.top = `${startPos.y}px`;
        line.style.transform = `rotate(${-angle}deg)`;
        line.style.transformOrigin = 'center center';
        debugGrid.appendChild(line);
      }

      // Add coordinate labels at tile centers
      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const pos = gridToScreen(col, row);

          const label = document.createElement('div');
          label.className = 'debug-label';
          label.style.left = `${pos.x - 12}px`;
          label.style.top = `${pos.y + gridHeight / 4}px`;
          label.textContent = `${row},${col}`;
          debugGrid.appendChild(label);
        }
      }
    }

    function renderTileGrid() {
      const world = document.getElementById('game-world');
      const groundLayer = world.querySelector('.ground-layer');

      const { tileWidth, tileHeight, gridWidth, gridHeight } = TILE_CONFIG;
      // Building size should fit within the 2x2 tile footprint
      const buildingSize = gridWidth * debugSizeMult;

      // Set CSS custom properties
      world.style.setProperty('--tile-width', `${tileWidth}px`);
      world.style.setProperty('--tile-height', `${tileHeight}px`);
      world.style.setProperty('--building-size', `${buildingSize}px`);
      world.style.setProperty('--placeholder-size', '42px');  // Smaller size for build UI

      // Clear existing tiles
      groundLayer.innerHTML = '';

      // Tile class mapping
      const tileClasses = {
        [TILE.GRASS]: 'tile-grass',
        [TILE.COBBLE]: 'tile-cobble',
        [TILE.DIRT]: 'tile-dirt',
      };

      // Get tiles occupied by buildings (for debug: hide them)
      const occupiedTiles = getOccupiedTiles();

      // Collect tiles with their z-order for proper rendering
      const tiles = [];

      for (let row = 0; row < TILE_MAP.length; row++) {
        for (let col = 0; col < TILE_MAP[row].length; col++) {
          // Skip tiles that are occupied by buildings (debug mode)
          if (occupiedTiles.has(`${row},${col}`)) {
            continue;
          }

          const tileType = TILE_MAP[row][col];
          const pos = gridToScreen(col, row);
          tiles.push({ row, col, tileType, pos });
        }
      }

      // Sort by z-order (back to front)
      tiles.sort((a, b) => a.pos.z - b.pos.z);

      // Render tiles
      tiles.forEach(({ row, col, tileType, pos }) => {
        const tile = document.createElement('div');
        tile.className = `tile ${tileClasses[tileType]}`;
        tile.dataset.row = row;
        tile.dataset.col = col;

        // Position tile centered on grid point
        tile.style.left = `${pos.x - tileWidth / 2}px`;
        tile.style.top = `${pos.y}px`;
        tile.style.zIndex = Math.floor(pos.z);

        groundLayer.appendChild(tile);
      });
    }

    function renderBuildings() {
      const world = document.getElementById('game-world');

      // Remove existing building elements (keep ground-layer)
      world.querySelectorAll('.building-slot').forEach(el => el.remove());

      // Render only placed buildings (no more empty slot markers)
      placedBuildings.forEach((building, index) => {
        const def = BUILDINGS[building.type];

        const div = document.createElement('div');
        div.className = 'building-slot built';
        div.dataset.buildingIndex = index;

        // Convert grid position to pixel coordinates
        const pos = gridToPixel(building.row, building.col, true);
        div.style.left = `${pos.x}px`;
        div.style.top = `${pos.y}px`;
        div.style.zIndex = pos.z;

        // Click handler - upgrade building
        div.onclick = (e) => {
          e.stopPropagation();  // Don't trigger game world click
          upgradeBuilding(index);
        };

        // Hover handlers - show building info
        div.onmouseenter = () => showBuildingInfoForPlaced(index);
        div.onmouseleave = () => hideBuildingInfo();

        // Show asset or emoji
        const level = building.level + 1;
        const assetPath = ASSETS[building.type]?.[level];

        if (assetPath) {
          const img = document.createElement('img');
          img.src = assetPath;
          img.className = 'building-image';
          img.alt = def.name;
          img.onerror = () => {
            img.style.display = 'none';
            const fallback = document.createElement('div');
            fallback.className = 'slot-placeholder';
            fallback.textContent = EMOJI_FALLBACKS[building.type];
            div.insertBefore(fallback, div.firstChild);
          };
          div.appendChild(img);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'slot-placeholder';
          placeholder.textContent = EMOJI_FALLBACKS[building.type];
          div.appendChild(placeholder);
        }

        // Level badge
        const badge = document.createElement('div');
        badge.className = 'level-badge';
        badge.textContent = level;
        div.appendChild(badge);

        world.appendChild(div);
      });
    }

    // Upgrade a placed building
    function upgradeBuilding(index) {
      const building = placedBuildings[index];
      if (!building) return;

      const def = BUILDINGS[building.type];

      // Check if max level
      if (building.level >= def.upgrades.length) {
        notify(`${def.name} is already at max level!`, 'info');
        return;
      }

      const upgradeCost = def.upgrades[building.level].cost;

      // Check if we can afford
      if (!canAfford(upgradeCost)) {
        notify(`Not enough resources to upgrade ${def.name}!`, 'error');
        return;
      }

      // Deduct cost
      Object.entries(upgradeCost).forEach(([res, amt]) => {
        resources[res] -= amt;
      });

      // Upgrade
      building.level++;
      notify(`${def.name} upgraded to level ${building.level + 1}!`, 'success');
      updateUI();
    }

    function updateUI() {
      const production = calculateProduction();
      
      // Update resources
      ['gold', 'wheat', 'stone', 'wood'].forEach(res => {
        document.getElementById(`${res}-value`).textContent = formatNumber(resources[res]);
        
        const rateEl = document.getElementById(`${res}-rate`);
        const rate = production[res];
        rateEl.textContent = (rate >= 0 ? '+' : '') + rate.toFixed(1) + '/s';
        rateEl.className = `resource-rate ${rate > 0 ? 'positive' : rate < 0 ? 'negative' : 'neutral'}`;
      });
      
      // Update stats
      const builtCount = placedBuildings.length;
      const totalLevels = placedBuildings.reduce((sum, b) => sum + (b.level + 1), 0);
      const netWorth = Object.values(resources).reduce((a, b) => a + b, 0);

      document.getElementById('stat-buildings').textContent = builtCount;
      document.getElementById('stat-levels').textContent = totalLevels;
      document.getElementById('stat-worth').textContent = formatNumber(netWorth);

      // Re-render tiles (to update occupied tiles) and buildings
      renderTileGrid();
      renderBuildings();

      // Re-apply placement highlights if in placement mode (tiles were just recreated)
      if (placementMode.active && placementMode.hoverRow !== null && placementMode.hoverCol !== null) {
        showPlacementHighlightAt(placementMode.hoverRow, placementMode.hoverCol);
      }

      // Update market trading panel if visible
      updateMarketTradingPanel();
    }

    // ==========================================
    // TAB SWITCHING
    // ==========================================
    function switchTab(tabName) {
      // Update tab buttons (right panel only)
      document.querySelectorAll('.right-panel .tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase().includes(tabName)) {
          btn.classList.add('active');
        }
      });

      // Update tab content (right panel only)
      document.querySelectorAll('.right-panel .tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    function switchLeftTab(tabName) {
      // Update tab buttons (left panel only)
      document.querySelectorAll('.left-tabbed-panel .tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      // Find and activate the correct button
      const buttons = document.querySelectorAll('.left-tabbed-panel .tab-btn');
      if (tabName === 'inspect') buttons[0].classList.add('active');
      if (tabName === 'build') buttons[1].classList.add('active');

      // Update tab content (left panel only)
      document.querySelectorAll('.left-tabbed-panel .tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`left-tab-${tabName}`).classList.add('active');

      // If switching to build tab, render the build list
      if (tabName === 'build') {
        renderBuildList();
      }
    }

    // ==========================================
    // PLACEMENT MODE & BUILD LIST (Dynamic Placement)
    // ==========================================
    let placementMode = {
      active: false,
      buildingType: null,
      hoverRow: null,    // Current hovered grid row
      hoverCol: null     // Current hovered grid col
    };

    function renderBuildList() {
      const container = document.getElementById('build-list');

      // Show all building types from BUILDINGS object
      const buildingTypes = Object.keys(BUILDINGS);

      container.innerHTML = buildingTypes.map(type => {
        const def = BUILDINGS[type];
        const icon = EMOJI_FALLBACKS[type];
        const unlocked = isUnlocked(def.unlockReq);
        const affordable = canAfford(def.baseCost);

        // Cost text
        const costText = Object.entries(def.baseCost)
          .map(([r, a]) => `${a}${r === 'gold' ? 'üí∞' : r === 'wheat' ? 'üåæ' : r === 'stone' ? '‚õèÔ∏è' : 'üå≤'}`)
          .join(' ');

        const isSelected = placementMode.active && placementMode.buildingType === type;
        const isLocked = !unlocked;

        let statusText = '';
        if (!unlocked) statusText = 'üîí Locked';

        return `
          <div class="build-item ${isLocked ? 'locked' : ''} ${isSelected ? 'selected' : ''}"
               onclick="${isLocked ? '' : `selectBuildingForPlacement('${type}')`}">
            <span class="build-item-icon">${icon}</span>
            <div class="build-item-info">
              <div class="build-item-name">${def.name}</div>
              <div class="build-item-cost ${affordable && !isLocked ? 'affordable' : 'unaffordable'}">${costText}</div>
            </div>
            ${statusText ? `<span class="build-item-status">${statusText}</span>` : ''}
          </div>
        `;
      }).join('');

      // Show/hide cancel button
      document.getElementById('build-cancel').style.display = placementMode.active ? 'block' : 'none';
    }

    function selectBuildingForPlacement(type) {
      if (placementMode.active && placementMode.buildingType === type) {
        // Clicking same building again cancels
        cancelPlacement();
        return;
      }

      placementMode.active = true;
      placementMode.buildingType = type;
      placementMode.hoverRow = null;
      placementMode.hoverCol = null;

      renderBuildList();
      notify(`Move cursor over the map to place ${BUILDINGS[type].name}`, 'info');
    }

    function cancelPlacement() {
      placementMode.active = false;
      placementMode.buildingType = null;
      placementMode.hoverRow = null;
      placementMode.hoverCol = null;

      clearPlacementHighlights();
      renderBuildList();
    }

    function clearPlacementHighlights() {
      // Remove highlight classes from all tiles
      document.querySelectorAll('.tile.highlighted-valid, .tile.highlighted-invalid').forEach(tile => {
        tile.classList.remove('highlighted-valid', 'highlighted-invalid');
      });
    }

    // Show 2x2 placement highlight at the specified grid position
    function showPlacementHighlightAt(row, col) {
      clearPlacementHighlights();

      if (!placementMode.active) return;

      const { rows, cols } = TILE_CONFIG;
      const isValid = canPlaceAt(row, col);
      const highlightClass = isValid ? 'highlighted-valid' : 'highlighted-invalid';

      // Highlight the 2x2 footprint by adding class to actual tile elements
      for (let dr = 0; dr < BUILDING_FOOTPRINT; dr++) {
        for (let dc = 0; dc < BUILDING_FOOTPRINT; dc++) {
          const tileRow = row + dr;
          const tileCol = col + dc;

          // Skip tiles outside the grid bounds
          if (tileRow < 0 || tileRow >= rows || tileCol < 0 || tileCol >= cols) {
            continue;
          }

          // Find the tile element by its data attributes
          const tile = document.querySelector(`.tile[data-row="${tileRow}"][data-col="${tileCol}"]`);
          if (tile) {
            tile.classList.add(highlightClass);
          }
        }
      }
    }

    // Handle mouse movement over game world for placement preview
    function handleGameWorldMouseMove(e) {
      if (!placementMode.active) return;

      const world = document.getElementById('game-world');
      const rect = world.getBoundingClientRect();

      // Get mouse position relative to game world
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // Convert to grid coordinates
      const gridPos = screenToGrid(mouseX, mouseY);
      // Offset so cursor is at bottom-left tile of 2x2 diamond
      const col = Math.floor(gridPos.col) - 1;
      const row = Math.floor(gridPos.row) - 1;

      // Only update if position changed
      if (row !== placementMode.hoverRow || col !== placementMode.hoverCol) {
        placementMode.hoverRow = row;
        placementMode.hoverCol = col;
        showPlacementHighlightAt(row, col);
      }
    }

    // Handle click on game world for placement
    function handleGameWorldClick(e) {
      if (!placementMode.active) return;

      const world = document.getElementById('game-world');
      const rect = world.getBoundingClientRect();

      // Get mouse position relative to game world
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // Convert to grid coordinates
      const gridPos = screenToGrid(mouseX, mouseY);
      // Same offset as mouse move - cursor at bottom-left tile of 2x2
      const col = Math.floor(gridPos.col) - 1;
      const row = Math.floor(gridPos.row) - 1;

      // Attempt to place building
      if (placeBuilding(placementMode.buildingType, row, col)) {
        // Successfully placed - exit placement mode
        cancelPlacement();
      }
    }

    // Handle mouse leaving game world - keep highlight persistent
    function handleGameWorldMouseLeave() {
      // Don't clear highlights - keep them visible until building is placed
      // The last valid position remains highlighted
    }

    // Setup mouse event listeners on game world
    function setupPlacementListeners() {
      const world = document.getElementById('game-world');
      world.addEventListener('mousemove', handleGameWorldMouseMove);
      world.addEventListener('click', handleGameWorldClick);
      world.addEventListener('mouseleave', handleGameWorldMouseLeave);
    }

    // ==========================================
    // BUILDING INFO PANEL
    // ==========================================
    let hoveredBuildingIndex = null;

    // Show info for a placed building
    function showBuildingInfoForPlaced(index) {
      hoveredBuildingIndex = index;
      const building = placedBuildings[index];
      if (!building) return;

      const def = BUILDINGS[building.type];

      // Hide empty message, show content
      document.getElementById('building-info-empty').style.display = 'none';
      document.getElementById('building-info-content').style.display = 'block';

      // Set basic info
      document.getElementById('info-icon').textContent = EMOJI_FALLBACKS[building.type];
      document.getElementById('info-name').textContent = def.name;

      const level = building.level + 1;
      const maxLevel = def.upgrades.length + 1;
      document.getElementById('info-level').textContent = `Level ${level} / ${maxLevel}`;
      document.getElementById('info-status').textContent = 'Built';
      document.getElementById('info-status').className = 'info-stat-value positive';

      // Upgrade cost
      if (building.level < def.upgrades.length) {
        const upgradeCost = def.upgrades[building.level].cost;
        const costText = Object.entries(upgradeCost)
          .map(([r, a]) => `${a}${r === 'gold' ? 'üí∞' : r === 'wheat' ? 'üåæ' : r === 'stone' ? '‚õèÔ∏è' : 'üå≤'}`)
          .join(' ');
        document.getElementById('info-upgrade-cost').textContent = costText;
        document.getElementById('info-upgrade-row').style.display = 'flex';
        document.querySelector('#info-upgrade-row .info-stat-label').textContent = 'Upgrade Cost';
      } else {
        document.getElementById('info-upgrade-row').style.display = 'none';
      }

      // Production info
      const mult = building.level > 0 ? def.upgrades[building.level - 1].mult : 1;
      let prodHTML = '';

      if (Object.keys(def.production).length > 0) {
        Object.entries(def.production).forEach(([res, amt]) => {
          const icon = res === 'gold' ? 'üí∞' : res === 'wheat' ? 'üåæ' : res === 'stone' ? '‚õèÔ∏è' : 'üå≤';
          prodHTML += `<div class="info-stat-row">
            <span class="info-stat-label">${icon} ${res.charAt(0).toUpperCase() + res.slice(1)}</span>
            <span class="info-stat-value positive">+${amt * mult}/s</span>
          </div>`;
        });
      }

      if (def.consumes) {
        Object.entries(def.consumes).forEach(([res, amt]) => {
          const icon = res === 'gold' ? 'üí∞' : res === 'wheat' ? 'üåæ' : res === 'stone' ? '‚õèÔ∏è' : 'üå≤';
          prodHTML += `<div class="info-stat-row">
            <span class="info-stat-label">${icon} ${res.charAt(0).toUpperCase() + res.slice(1)}</span>
            <span class="info-stat-value negative">-${amt}/s</span>
          </div>`;
        });
      }

      if (def.storageBonus) {
        const bonus = def.storageBonus * mult;
        prodHTML += `<div class="info-stat-row">
          <span class="info-stat-label">üì¶ Storage</span>
          <span class="info-stat-value positive">+${bonus}</span>
        </div>`;
      }

      document.getElementById('info-production-list').innerHTML = prodHTML || '<div class="info-stat-row"><span class="info-stat-label">No production</span></div>';
    }

    function hideBuildingInfo() {
      hoveredBuildingIndex = null;
      document.getElementById('building-info-empty').style.display = 'block';
      document.getElementById('building-info-content').style.display = 'none';
    }

    // ==========================================
    // DEBUG SLIDER FUNCTIONS
    // ==========================================
    function setupDebugSliders() {
      const xSlider = document.getElementById('x-offset-slider');
      const ySlider = document.getElementById('y-offset-slider');
      const sizeSlider = document.getElementById('size-mult-slider');
      const cursorXSlider = document.getElementById('cursor-x-slider');
      const cursorYSlider = document.getElementById('cursor-y-slider');

      xSlider.addEventListener('input', (e) => {
        debugOffsetX = parseFloat(e.target.value);
        document.getElementById('x-offset-value').textContent = debugOffsetX;
        updateUI();
      });

      ySlider.addEventListener('input', (e) => {
        debugOffsetY = parseFloat(e.target.value);
        document.getElementById('y-offset-value').textContent = debugOffsetY;
        updateUI();
      });

      sizeSlider.addEventListener('input', (e) => {
        debugSizeMult = parseFloat(e.target.value);
        document.getElementById('size-mult-value').textContent = debugSizeMult.toFixed(1);
        updateUI();
      });

      cursorXSlider.addEventListener('input', (e) => {
        cursorOffsetX = parseFloat(e.target.value);
        document.getElementById('cursor-x-value').textContent = cursorOffsetX;
      });

      cursorYSlider.addEventListener('input', (e) => {
        cursorOffsetY = parseFloat(e.target.value);
        document.getElementById('cursor-y-value').textContent = cursorOffsetY;
      });
    }

    function copyDebugValues() {
      const values = `debugOffsetX = ${debugOffsetX};\ndebugOffsetY = ${debugOffsetY};\ndebugSizeMult = ${debugSizeMult};\ncursorOffsetX = ${cursorOffsetX};\ncursorOffsetY = ${cursorOffsetY};`;
      navigator.clipboard.writeText(values).then(() => {
        notify('Debug values copied to clipboard!', 'success');
      }).catch(() => {
        console.log(values);
        notify('Values logged to console', 'info');
      });
    }

    // ==========================================
    // INITIALIZATION
    // ==========================================
    function init() {
      renderDebugGrid();  // Show debug grid (remove when done designing)
      updateUI();  // Renders tiles and buildings

      // Initialize stipend indicator
      updateStipendIndicator();

      // Initialize milestone panel
      updateMilestonePanel();

      // Initialize market trading panel (hidden until market built)
      updateMarketTradingPanel();

      // Schedule first merchant visit
      scheduleMerchantVisit(true);

      // Setup debug sliders
      setupDebugSliders();

      // Setup placement mode mouse listeners
      setupPlacementListeners();

      // Start game tick (1 second)
      setInterval(tick, 1000);

      // Start stipend tick (2 seconds) - faster than main tick for responsiveness
      setInterval(stipendTick, 2000);
    }

    init();
  </script>
</body>
</html>
